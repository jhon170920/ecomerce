<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîì Test de Seguridad - Manipulaci√≥n de Precios</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { 
            color: #667eea; 
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .test-section h3 {
            color: #333;
            margin-bottom: 15px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: transform 0.2s;
        }
        button:hover { transform: scale(1.05); }
        button.danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        button.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 10px 0;
            font-size: 14px;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            display: none;
        }
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .code-block {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin: 10px 0;
        }
        .step {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        .step-number {
            display: inline-block;
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            margin-right: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <span>üîì</span>
            Test de Seguridad: Manipulaci√≥n de Precios
        </h1>
        <p style="color: #666; margin-bottom: 20px;">
            Esta p√°gina te ense√±a c√≥mo manipular precios desde el frontend y c√≥mo el backend los detecta
        </p>

        <div class="warning">
            <strong>‚ö†Ô∏è Advertencia √âtica:</strong> Esta herramienta es solo para fines educativos. 
            Nunca intentes manipular precios en aplicaciones reales de producci√≥n.
        </div>

        <!-- SECCI√ìN 1: M√âTODOS DE MANIPULACI√ìN -->
        <div class="test-section">
            <h3>üìù M√©todo 1: Consola del Navegador (Chrome DevTools)</h3>
            
            <div class="step">
                <span class="step-number">1</span>
                Abre la consola del navegador:
                <div class="code-block">
                    ‚Ä¢ Windows/Linux: <strong>Ctrl + Shift + J</strong><br>
                    ‚Ä¢ Mac: <strong>Cmd + Option + J</strong><br>
                    ‚Ä¢ O clic derecho ‚Üí "Inspeccionar" ‚Üí pesta√±a "Console"
                </div>
            </div>

            <div class="step">
                <span class="step-number">2</span>
                Modifica el carrito en localStorage:
                <pre>// Ver el carrito actual
console.log(JSON.parse(localStorage.getItem("carrito")));

// Manipular: Cambiar precio a $1
let carrito = JSON.parse(localStorage.getItem("carrito"));
carrito[0].precio = 1;  // ‚ö†Ô∏è Intento de fraude
localStorage.setItem("carrito", JSON.stringify(carrito));

// Verificar el cambio
console.log("Nuevo carrito:", carrito);</pre>
            </div>

            <div class="step">
                <span class="step-number">3</span>
                Recarga la p√°gina del carrito y finaliza la compra
                <div class="code-block">
                    El backend detectar√° que el total no coincide y rechazar√° el pedido ‚ùå
                </div>
            </div>
        </div>

        <!-- SECCI√ìN 2: MANIPULACI√ìN DIRECTA DE FETCH -->
        <div class="test-section">
            <h3>üõ†Ô∏è M√©todo 2: Interceptar la Petici√≥n Fetch</h3>
            
            <div class="step">
                <span class="step-number">1</span>
                Sobrescribe la funci√≥n finalizarCompra en la consola:
                <pre>// Guardar la funci√≥n original
const finalizarCompraOriginal = window.finalizarCompra;

// Sobrescribir con versi√≥n manipulada
window.finalizarCompra = async function() {
    const carrito = JSON.parse(localStorage.getItem("carrito")) || [];
    const usuario = JSON.parse(localStorage.getItem("usuario"));
    
    const pedido = {
        productos: carrito.map(item => ({
            producto_id: item._id || item.id,
            nombre: item.nombre,
            precio: item.precio,
            cantidad: item.cantidad
        })),
        precio_total: 1,  // ‚ö†Ô∏è MANIPULADO: $1 en lugar del total real
        email: usuario.email,
        telefono: usuario.telefono,
        direccion: "Calle Falsa 123",
        metodo_pago: "efectivo"
    };
    
    console.log("üî¥ Enviando pedido manipulado:", pedido);
    
    const response = await fetch("http://localhost:8081/api/pedido", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(pedido)
    });
    
    const data = await response.json();
    console.log("Respuesta:", data);
};</pre>
            </div>

            <div class="step">
                <span class="step-number">2</span>
                Ahora haz clic en el bot√≥n "Finalizar Compra" en tu p√°gina
                <div class="code-block">
                    Resultado esperado: <strong style="color: #f5576c;">‚ùå Error 400 - Precio manipulado detectado</strong>
                </div>
            </div>
        </div>

        <!-- SECCI√ìN 3: PRUEBAS AUTOM√ÅTICAS -->
        <div class="test-section">
            <h3>ü§ñ M√©todo 3: Pruebas Autom√°ticas desde esta P√°gina</h3>
            
            <p style="margin-bottom: 15px;">Haz clic en los botones para probar diferentes escenarios:</p>

            <button class="success" onclick="testPedidoValido()">
                ‚úÖ Pedido V√°lido (debe pasar)
            </button>

            <button class="danger" onclick="testPrecioManipulado()">
                üî¥ Precio Manipulado $1 (debe fallar)
            </button>

            <button class="danger" onclick="testPrecioManipuladoMenor()">
                üî¥ 50% de Descuento Falso (debe fallar)
            </button>

            <button onclick="testPrecioRedondeado()">
                ‚ö†Ô∏è Diferencia de Redondeo (debe pasar)
            </button>

            <div id="result" class="result"></div>
        </div>

        <!-- SECCI√ìN 4: MODIFICAR EN TIEMPO REAL -->
        <div class="test-section">
            <h3>‚ö° M√©todo 4: Modificar con Extension del Navegador</h3>
            
            <div class="step">
                <span class="step-number">1</span>
                Instala una extensi√≥n como <strong>"EditThisCookie"</strong> o <strong>"Storage Area Explorer"</strong>
            </div>

            <div class="step">
                <span class="step-number">2</span>
                Abre la extensi√≥n y busca la clave <code>carrito</code> en localStorage
            </div>

            <div class="step">
                <span class="step-number">3</span>
                Edita directamente el JSON y cambia el precio
            </div>

            <div class="step">
                <span class="step-number">4</span>
                Recarga y finaliza compra (ser√° detectado ‚ùå)
            </div>
        </div>

        <!-- LOGS DEL BACKEND -->
        <div class="test-section">
            <h3>üìä Qu√© ver√°s en la consola del Backend</h3>
            <pre>// PEDIDO V√ÅLIDO ‚úÖ
üì¶ Datos recibidos: { precio_total: 150000, productos: [...] }
üí∞ Precio calculado: 150000
‚úÖ Diferencia: $0 - Pedido aprobado

// PEDIDO MANIPULADO ‚ùå
üì¶ Datos recibidos: { precio_total: 1, productos: [...] }
üí∞ Precio calculado: 150000
‚ö†Ô∏è ALERTA: Precio manipulado. Enviado: 1, Calculado: 150000
‚ùå Pedido rechazado - Error 400</pre>
        </div>

    </div>

    <script>
        // PRUEBA 1: Pedido v√°lido
        async function testPedidoValido() {
            const result = document.getElementById('result');
            result.style.display = 'block';
            result.className = 'result';
            result.innerHTML = '‚è≥ Enviando pedido v√°lido...';

            const pedido = {
                productos: [
                    { producto_id: "123", nombre: "Laptop", precio: 50000, cantidad: 2 },
                    { producto_id: "456", nombre: "Mouse", precio: 25000, cantidad: 1 }
                ],
                precio_total: 125000,  // ‚úÖ CORRECTO: (50000*2) + (25000*1) = 125000
                email: "test@example.com",
                telefono: "3001234567",
                direccion: "Calle Test 123, Bogot√°, 110111",
                metodo_pago: "efectivo"
            };

            try {
                const response = await fetch("http://localhost:8081/api/pedido", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(pedido)
                });

                const data = await response.json();

                if (response.ok) {
                    result.className = 'result success';
                    result.innerHTML = `‚úÖ <strong>PEDIDO APROBADO</strong><br><br>
                        El backend calcul√≥: $125,000<br>
                        Frontend envi√≥: $125,000<br>
                        Diferencia: $0<br><br>
                        <pre>${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    result.className = 'result error';
                    result.innerHTML = `‚ùå Error inesperado: ${data.message}`;
                }
            } catch (error) {
                result.className = 'result error';
                result.innerHTML = `‚ùå Error de conexi√≥n: ${error.message}<br>¬øEst√° el servidor corriendo?`;
            }
        }

        // PRUEBA 2: Precio manipulado a $1
        async function testPrecioManipulado() {
            const result = document.getElementById('result');
            result.style.display = 'block';
            result.className = 'result';
            result.innerHTML = '‚è≥ Enviando pedido con precio manipulado...';

            const pedido = {
                productos: [
                    { producto_id: "123", nombre: "Laptop", precio: 50000, cantidad: 2 },
                    { producto_id: "456", nombre: "Mouse", precio: 25000, cantidad: 1 }
                ],
                precio_total: 1,  // ‚ùå MANIPULADO: Deber√≠a ser 125000
                email: "hacker@example.com",
                telefono: "3001234567",
                direccion: "Calle Falsa 123",
                metodo_pago: "efectivo"
            };

            try {
                const response = await fetch("http://localhost:8081/api/pedido", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(pedido)
                });

                const data = await response.json();

                if (!response.ok) {
                    result.className = 'result success';
                    result.innerHTML = `‚úÖ <strong>INTENTO DE FRAUDE BLOQUEADO</strong><br><br>
                        El backend detect√≥ la manipulaci√≥n:<br>
                        ‚Ä¢ Frontend envi√≥: $1<br>
                        ‚Ä¢ Backend calcul√≥: $125,000<br>
                        ‚Ä¢ Diferencia: $124,999<br><br>
                        <strong>Mensaje del servidor:</strong><br>
                        ${data.message}<br><br>
                        ${data.detalle || ''}`;
                } else {
                    result.className = 'result error';
                    result.innerHTML = `‚ùå <strong>FALLO DE SEGURIDAD</strong><br>
                        El servidor acept√≥ el precio manipulado. Necesitas actualizar el controller.`;
                }
            } catch (error) {
                result.className = 'result error';
                result.innerHTML = `‚ùå Error de conexi√≥n: ${error.message}`;
            }
        }

        // PRUEBA 3: 50% de descuento falso
        async function testPrecioManipuladoMenor() {
            const result = document.getElementById('result');
            result.style.display = 'block';
            result.className = 'result';
            result.innerHTML = '‚è≥ Enviando pedido con 50% de "descuento"...';

            const pedido = {
                productos: [
                    { producto_id: "123", nombre: "Laptop", precio: 1500000, cantidad: 1 }
                ],
                precio_total: 750000,  // ‚ùå MANIPULADO: 50% del precio real
                email: "test@example.com",
                telefono: "3001234567",
                direccion: "Calle Test 123",
                metodo_pago: "tarjeta"
            };

            try {
                const response = await fetch("http://localhost:8081/api/pedido", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(pedido)
                });

                const data = await response.json();

                if (!response.ok) {
                    result.className = 'result success';
                    result.innerHTML = `‚úÖ <strong>INTENTO DE FRAUDE BLOQUEADO</strong><br><br>
                        Usuario intent√≥ aplicar 50% de descuento falso<br>
                        ‚Ä¢ Frontend envi√≥: $750,000<br>
                        ‚Ä¢ Backend calcul√≥: $1,500,000<br><br>
                        ${data.message}`;
                } else {
                    result.className = 'result error';
                    result.innerHTML = `‚ùå FALLO: El servidor acept√≥ el precio manipulado`;
                }
            } catch (error) {
                result.className = 'result error';
                result.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }

        // PRUEBA 4: Diferencia m√≠nima por redondeo (debe pasar)
        async function testPrecioRedondeado() {
            const result = document.getElementById('result');
            result.style.display = 'block';
            result.className = 'result';
            result.innerHTML = '‚è≥ Probando diferencia de redondeo...';

            const pedido = {
                productos: [
                    { producto_id: "123", nombre: "Producto", precio: 33333.33, cantidad: 1 }
                ],
                precio_total: 33333,  // Diferencia de $0.33 por redondeo
                email: "test@example.com",
                telefono: "3001234567",
                direccion: "Calle Test 123",
                metodo_pago: "efectivo"
            };

            try {
                const response = await fetch("http://localhost:8081/api/pedido", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(pedido)
                });

                const data = await response.json();

                if (response.ok) {
                    result.className = 'result success';
                    result.innerHTML = `‚úÖ <strong>PEDIDO APROBADO</strong><br><br>
                        Diferencia m√≠nima por redondeo aceptada<br>
                        (diferencia < $1 es v√°lida)`;
                } else {
                    result.className = 'result error';
                    result.innerHTML = `‚ùå ${data.message}`;
                }
            } catch (error) {
                result.className = 'result error';
                result.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }
    </script>
</body>
</html>